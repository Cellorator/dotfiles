import {
    LeftHardCircleSeparator,
    RightHardCircleSeparator
} from '../widgets/separator.js'

const notifications = await Service.import("notifications")

export default function Notifications(monitor = 0) {
    const list = Widget.Box({
        vertical: true,
        children: notifications.popups.map(Notification),
    })

    function onNotified(_, /** @type {number} */ id) {
        const n = notifications.getNotification(id)
        if (n)
            list.children = [Notification(n), ...list.children]
    }

    function onDismissed(_, /** @type {number} */ id) {
        list.children.find(n => n.attribute.id === id)?.destroy()
    }

    list.hook(notifications, onNotified, "notified")
        .hook(notifications, onDismissed, "dismissed")

    return Widget.Window({
        monitor,
        name: `notifications${monitor}`,
        class_name: "notification-popups",
        anchor: ['top', 'right'],
        child: Widget.Box({
            css: 'min-width: 2px; min-height: 2px',
            vertical: true,
            class_name: "notifications",
            child: list
        })
    })
}

function Notification(n) {
    // const title = Widget.CenterBox({
    //     className: 'title',
    //     hpack: 'fill',
    //     startWidget: LeftHardCircleSeparator(),
    //     centerWidget: Widget.Label({
    //         label: n.summary,
    //         use_markup: true,
    //     }),
    //     endWidget: RightHardCircleSeparator()
    // })
    const title = Widget.Label({
        label: n.summary,
    })
    const body = Widget.Label({
        class_name: "body",
        use_markup: true,
        label: n.body,
        wrap: true,
    })

    const actions = Widget.Box({
        class_name: "actions",
        children: n.actions.map(({ id, label }) => Widget.Button({
            class_name: "action-button",
            on_clicked: () => {
                n.invoke(id)
                n.dismiss()
            },
            hexpand: true,
            child: Widget.Label(label),
        })),
    })

    return Widget.EventBox(
        {
            class_name: `notification ${n.urgency}`,
            attribute: { id: n.id },
            on_primary_click: n.dismiss,
        },
        Widget.Box(
            {
                vertical: true,
            },
            title,
            body,
            actions
        ),
    )
}
